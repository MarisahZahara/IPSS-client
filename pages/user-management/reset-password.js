import { Card, Breadcrumb, Button, Form, Input, Select, DatePicker, message } from 'antd';
import Head from 'next/head'
import LayoutBase from "../../layout/base";
import { useRouter } from "next/router";
import { useEffect, useState } from "react";
import { resetPassword, getEmployeeID } from "../api/user-management"
import Cookies from "js-cookie";
import { authPage } from '../../middlewares/authorizationPage'
import authorization from '../../middlewares/authorization'

export async function getServerSideProps(ctx) {
  try {
    const { token } = await authPage(ctx);
    const decode = await authorization(token);
    if (decode) {
      return {
        props: {
          dataToken: decode,
        },
      };
    } else {
      return ctx.res
        .writeHead(302, {
          Location: "/",
        })
        .end();
    }
  } catch (error) {
    return ctx.res
      .writeHead(302, {
        Location: "/",
      })
      .end();
  }
}

export default function ResetPassword(dataToken) {
  const router = useRouter();
  const { id } = router.query

  const [form] = Form.useForm()
  const [Loading, setLoading] = useState(false)

  useEffect( () => {
    onDataView()
  }, [])

  const layout = {
    labelCol: {
      span: 8,
    },
    wrapperCol: {
      span: 16,
    },
  }

  const onDataView = async () => {
    try {
      const token = Cookies.get("token")
      const response = await getEmployeeID(id, token);
      if (response.status === 200) {
        form.setFieldsValue({
          email: response.data.email,
        })
      }
    } catch (error) {
      message.error(
        error.response.data.message
      )
    }
  }

  const onUserManagement = () => {
    router.push("/user-management");
  }

  const onResetPassword = async (values) => {
    try {
      setLoading(true)
      const token = Cookies.get("token")
      let data = new FormData()
      data.append('password', values.password)
      const response = await resetPassword(id, data, token);
      if (response.status === 200) {
        message.success(
          "Reset Password Berhasil!"
        );
        setTimeout(() => {
          router.push("/user-management");
        }, 2000)
        setLoading(false)
      }
    } catch (error) {
      message.error(
        error.response.data.message
      )
      setLoading(false)
    } finally {
      setLoading(false)
    }
  }

  return (
    <LayoutBase dataToken={dataToken}>
      <Head>
        <title>Ipsos Application</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Breadcrumb className="breadcrumb">
        <Breadcrumb.Item>
          <span onClick={onUserManagement}>User Management</span>
        </Breadcrumb.Item>
        <Breadcrumb.Item>Reset Password User</Breadcrumb.Item>
      </Breadcrumb>
        <Card
          title="Reset Password User"
        >
          <Form form={form} {...layout} name="nest-messages" autoComplete="off" onFinish={onResetPassword}>
            <Form.Item
              name="email"
              label="Email"
              rules={[
                {
                  type: 'email',
                  message: 'The input is not valid E-mail!',
                },
                {
                  required: true,
                  message: 'Please input your E-mail!',
                },
              ]}
            >
              <Input placeholder="Input Email here" disabled={true}/>
            </Form.Item>
            <Form.Item
              name="password"
              label="Password"
              rules={[
                {
                  required: true,
                  message: 'Please input your password!',
                },
              ]}
            >
              <Input.Password placeholder="Input Password here"/>
            </Form.Item>
            <Form.Item
              name="confirm"
              label="Confirm Password"
              dependencies={['password']}
              hasFeedback
              rules={[
                {
                  required: true,
                  message: 'Please confirm your password!',
                },
                ({ getFieldValue }) => ({
                  validator(_, value) {
                    if (!value || getFieldValue('password') === value) {
                      return Promise.resolve();
                    }
                    return Promise.reject(new Error('The two passwords that you entered do not match!'));
                  },
                }),
              ]}
            >
              <Input.Password placeholder="Input Confirm Password here"/>
            </Form.Item>
            <Form.Item
              wrapperCol={{
                ...layout.wrapperCol,
                offset: 8,
              }}
            >
              <Button type="primary" htmlType="submit" className="button-footer-form-side" loading={Loading}>
                Reset Password
              </Button>
              <Button onClick={onUserManagement} loading={Loading}>
                Cancel
              </Button>
            </Form.Item>
          </Form>
        </Card>
    </LayoutBase>
  );
}
